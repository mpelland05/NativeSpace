fs = filesep;

pnames ={'CBxxxVDAlCh','CBxxxVDAnBe','CBxxxVDBeMe','CBxxxVDDiCe','CBxxxVDFrCo','CBxxxVDLL','CBxxxVDMaLa','CBxxxVDMaDu','CBxxxVDMoBe','CBxxxVDNaTe','CBxxxVDSePo','CBxxxVDSoSa','CBxxxVDYP','CBxxxVDYvLa','SCxxxVDCJ','SCxxxVDChJa','SCxxxVDClDe','SCxxxVDGeAl','SCxxxVDJM','SCxxxVDJeRe','SCxxxVDJoFr','SCxxxVDKaFo','SCxxxVDLALH','SCxxxVDMaSa','SCxxxVDNiLe','SCxxxVDNiMi','SCxxxVDOL','SCxxxVDPG','SCxxxVDSG','SCxxxVDTJ'}; %cell of string, name of participant(s)

PathData = '/home/mpelland/database/blindtvr/fmri/Comp_ReHo_STD/STD/Smooth/';
PathOut = '/home/mpelland/database/blindtvr/ResultsReHo/'
name_test = 'STD_Smooth';
%%%%%%%%%%%%%%%%%%%
%%% Start here
%%%%%%%%%%%%%%%%%%%

%%%Build mask
[thdr, tvol] = niak_read_vol(strcat(PathData,pnames{1},'.mnc.gz'));
mask = ones(size(tvol));
hdr = thdr;

for pp = 1:length(pnames),
    strcat('mask_',pnames{pp})
    
    [thdr, tvol] = niak_read_vol(strcat(PathData,pnames{pp},'.mnc.gz'));
    %size(find(tvol ~= 0))
    mask = mask.*(tvol ~= 0);
end

loc = find(mask == 1); size(loc)

for pp = 1:length(pnames),
    strcat('vol_',pnames{pp})
    
    [thdr, tvol] = niak_read_vol(strcat(PathData,pnames{pp},'.mnc.gz'));
    mask = mask.*tvol;
end

%%% set y for the GLM
model_group.y = zeros(length(pnames),length(loc));
for pp = 1:length(pnames),
    [thdr, tvol] = niak_read_vol(strcat(PathData,pnames{pp},'.mnc.gz'));
    
    model_group.y(pp,:) = tvol(loc);
end

%%% Set the model for the glm
model_group.x =...
    [1   0.5333   -0.4   -0.4   -0.0640; ...
    1    0.5333   20.6   -0.4    0.0860; ...
    1    0.5333   15.6   -0.4    0.0360; ...
    1    0.5333  -14.4   -0.4   -0.0140; ...
    1    0.5333   13.6   -0.4    0.0960; ...
    1    0.5333   -2.4   -0.4   -0.0340; ...
    1    0.5333  -13.4    0.6   -0.0440; ...
    1    0.5333   -1.4   -0.4   -0.0240; ...
    1    0.5333   15.6    0.6    0.1360; ...
    1    0.5333   -8.4    0.6    0.0160; ...
    1    0.5333    7.6   -0.4    0.0860; ...
    1    0.5333   -9.4    0.6   -0.0340; ...
    1    0.5333    2.6   -0.4    0.0460; ...
    1    0.5333    5.6   -0.4    0.0960; ...
    1   -0.4667   15.6    0.6   -0.0740; ...
    1   -0.4667  -10.4    0.6   -0.0240; ...
    1   -0.4667  -12.4    0.6   -0.0740; ...
    1   -0.4667  -10.4    0.6   -0.0740; ...
    1   -0.4667   19.6    0.6   -0.0540; ...
    1   -0.4667  -15.4   -0.4    0.0160; ...
    1   -0.4667   -6.4   -0.4   -0.0640; ...
    1   -0.4667   -0.4   -0.4   -0.0140; ...
    1   -0.4667  -17.4    0.6   -0.0740; ...
    1   -0.4667   19.6    0.6    0.0360; ...
    1   -0.4667   14.6    0.6    0.0360; ...
    1   -0.4667   15.6   -0.4    0.0160; ...
    1   -0.4667  -10.4   -0.4   -0.0240; ...
    1   -0.4667   -6.4   -0.4    0.0060; ...
    1   -0.4667  -15.4   -0.4    0.0460; ...
    1   -0.4667  -11.4   -0.4   -0.0640];

%%% set the contrast
model_group.c = [0 1 0 0 0]';

%%% set options
opt.test = 'ttest';
opt.flag_eff = true;

%%% Launch GLm
[results,opt] = niak_glm(model_group,opt);

%%% Create pce volume
vol = zeros(size(mask));
vol(loc) = results.pce;

hdr.file_name = strcat(PathOut,name_test,'_pce.mnc.gz');

niak_write_vol(hdr,vol);

%%%% save results
results.voxel_indexes = loc;
save('-mat',strcat(PathOut,name_test,'.mat'));

